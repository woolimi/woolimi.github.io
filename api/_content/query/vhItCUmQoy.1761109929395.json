{"_path":"/codes/aws/restore-query-string-with-lambda-edge","_dir":"aws","_draft":false,"_partial":false,"_locale":"","title":"lambda@edge function to fix Amplify query strings bug","description":"Amplify doesn't forward query string when it's 301 redirection. Here is the code that how to fix this issue with lambda@edge function","category":["AWS"],"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"setup-ab-test-with-lambdaedge-function"},"children":[{"type":"text","value":"Setup AB test with Lambda@edge function"}]},{"type":"element","tag":"h2","props":{"id":"issue"},"children":[{"type":"text","value":"Issue"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Amplify doesn't forward query string when it's 301 redirection."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Before: "},{"type":"element","tag":"a","props":{"href":"https://example.com/some-page/?test=1","rel":["nofollow"]},"children":[{"type":"text","value":"https://example.com/some-page/?test=1"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"After : "},{"type":"element","tag":"a","props":{"href":"https://example.com/other-page/","rel":["nofollow"]},"children":[{"type":"text","value":"https://example.com/other-page/"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Here is the code that how to fix this issue with lambda@edge function"}]},{"type":"element","tag":"h2","props":{"id":"code"},"children":[{"type":"text","value":"Code"}]},{"type":"element","tag":"pre","props":{"className":"language-js shiki shiki-themes github-dark","code":"export const handler = (event, context, callback) => {\n    const request = event.Records[0].cf.request;\n    const response = event.Records[0].cf.response;\n    \n    if (response.status === \"301\" && request.querystring) {\n        response.headers.location[0].value += `?${request.querystring}`;\n    }\n\n    return callback(null, response);\n}\n","language":"js","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"export"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#FFAB70"},"children":[{"type":"text","value":"event"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#FFAB70"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#FFAB70"},"children":[{"type":"text","value":"callback"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" event.Records["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"].cf.request;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":" response"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" event.Records["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"].cf.response;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"    \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" (response.status "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" \"301\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":" &&"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":" request.querystring) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"        response.headers.location["}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"].value "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"+="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":" `?${"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"querystring"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#9ECBFF"},"children":[{"type":"text","value":"}`"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#F97583"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#B392F0"},"children":[{"type":"text","value":" callback"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#79B8FF"},"children":[{"type":"text","value":"null"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":", response);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#E1E4E8"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"issue","depth":2,"text":"Issue"},{"id":"code","depth":2,"text":"Code"}]}},"_type":"markdown","_id":"content:codes:AWS:restore-query-string-with-lambda-edge.md","_source":"content","_file":"codes/AWS/restore-query-string-with-lambda-edge.md","_stem":"codes/AWS/restore-query-string-with-lambda-edge","_extension":"md","createdAt":"2023-06-28T20:35:42.000Z","updatedAt":"2024-06-29T09:09:07.000Z"}